# å¼€å‘æ¨¡å¼Dockerfile - ä¼˜åŒ–ç¼–è¯‘é€Ÿåº¦å’Œä¾èµ–ç¼“å­˜
FROM golang:1.24-alpine

WORKDIR /app

# å®‰è£…æ„å»ºå’Œè¿è¡Œæ—¶ä¾èµ–
RUN apk add --no-cache \
    git \
    gcc \
    libc-dev \
    python3 \
    python3-dev \
    py3-pip \
    pax-utils \
    bind-tools \
    file \
    deno \
    curl \
    build-base

# è®¾ç½®Goç¯å¢ƒå˜é‡ä»¥ä¼˜åŒ–æ¨¡å—ç¼“å­˜
ENV GOPROXY=https://proxy.golang.org,direct
ENV GOSUMDB=sum.golang.org
ENV GO111MODULE=on
ENV CGO_ENABLED=1

# åˆ›å»ºPythonè™šæ‹Ÿç¯å¢ƒå¹¶å®‰è£…Pythonä¾èµ–
RUN python3 -m venv --copies --upgrade-deps /app/.venv && \
    . /app/.venv/bin/activate && \
    pip install --no-cache-dir \
        urllib3==1.26.16 \
        h11==0.16.0 \
        httpx==0.28.1 \
        pillow==11.2.0 \
        pdfplumber==0.11.7 \
        python-docx==1.2.0 \
        numpy==2.3.1 \
        pymupdf

# è®¾ç½®PATHä»¥ä¼˜å…ˆä½¿ç”¨è™šæ‹Ÿç¯å¢ƒ
ENV PATH="/app/.venv/bin:${PATH}"

# åˆå§‹åŒ–denoè¿è¡Œæ—¶ï¼ˆå¯é€‰ï¼‰
RUN deno run -A jsr:@eyurtsev/pyodide-sandbox -c "print('Deno initialized')" || true

# åˆ›å»ºæºä»£ç ç›®å½•
RUN mkdir -p /app/src

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app/src

# å¼€å‘æ¨¡å¼å¯åŠ¨è„šæœ¬
RUN echo '#!/bin/sh' > /app/dev-start.sh && \
    echo 'set -e' >> /app/dev-start.sh && \
    echo 'echo "ğŸš€ å¼€å‘æ¨¡å¼å¯åŠ¨ä¸­..."' >> /app/dev-start.sh && \
    echo 'cd /app/src' >> /app/dev-start.sh && \
    echo '' >> /app/dev-start.sh && \
    echo '# æ£€æŸ¥go.modæ˜¯å¦å­˜åœ¨' >> /app/dev-start.sh && \
    echo 'if [ ! -f "go.mod" ]; then' >> /app/dev-start.sh && \
    echo '  echo "âŒ go.modæ–‡ä»¶æœªæ‰¾åˆ°ï¼Œè¯·ç¡®ä¿æºä»£ç å·²æ­£ç¡®æŒ‚è½½"' >> /app/dev-start.sh && \
    echo '  exit 1' >> /app/dev-start.sh && \
    echo 'fi' >> /app/dev-start.sh && \
    echo '' >> /app/dev-start.sh && \
    echo '# æ™ºèƒ½ä¾èµ–ç®¡ç†ï¼šåªæœ‰go.modæˆ–go.sumå˜åŒ–æ—¶æ‰é‡æ–°ä¸‹è½½' >> /app/dev-start.sh && \
    echo 'if [ ! -f "/tmp/go-deps-hash" ] || ! sha256sum go.mod go.sum | sha256sum -c /tmp/go-deps-hash > /dev/null 2>&1; then' >> /app/dev-start.sh && \
    echo '  echo "ğŸ“¦ æ£€æµ‹åˆ°ä¾èµ–å˜åŒ–ï¼Œä¸‹è½½Goæ¨¡å—..."' >> /app/dev-start.sh && \
    echo '  go mod download' >> /app/dev-start.sh && \
    echo '  if [ $? -eq 0 ]; then' >> /app/dev-start.sh && \
    echo '    sha256sum go.mod go.sum > /tmp/go-deps-hash' >> /app/dev-start.sh && \
    echo '    echo "âœ… Goæ¨¡å—ä¸‹è½½å®Œæˆå¹¶ç¼“å­˜"' >> /app/dev-start.sh && \
    echo '  else' >> /app/dev-start.sh && \
    echo '    echo "âŒ Goæ¨¡å—ä¸‹è½½å¤±è´¥"' >> /app/dev-start.sh && \
    echo '    exit 1' >> /app/dev-start.sh && \
    echo '  fi' >> /app/dev-start.sh && \
    echo 'else' >> /app/dev-start.sh && \
    echo '  echo "âœ… ä¾èµ–æ— å˜åŒ–ï¼Œè·³è¿‡ä¸‹è½½ï¼ˆä½¿ç”¨ç¼“å­˜ï¼‰"' >> /app/dev-start.sh && \
    echo 'fi' >> /app/dev-start.sh && \
    echo '' >> /app/dev-start.sh && \
    echo '# ç¼–è¯‘Goåº”ç”¨' >> /app/dev-start.sh && \
    echo 'echo "ğŸ”§ ç¼–è¯‘Goåº”ç”¨..."' >> /app/dev-start.sh && \
    echo 'go build -ldflags="-s -w" -o /app/opencoze main.go' >> /app/dev-start.sh && \
    echo 'if [ $? -eq 0 ]; then' >> /app/dev-start.sh && \
    echo '  echo "âœ… ç¼–è¯‘æˆåŠŸ"' >> /app/dev-start.sh && \
    echo 'else' >> /app/dev-start.sh && \
    echo '  echo "âŒ ç¼–è¯‘å¤±è´¥"' >> /app/dev-start.sh && \
    echo '  exit 1' >> /app/dev-start.sh && \
    echo 'fi' >> /app/dev-start.sh && \
    echo '' >> /app/dev-start.sh && \
    echo '# å¤åˆ¶å¿…è¦çš„Pythonè„šæœ¬ï¼ˆå¦‚æœå­˜åœ¨ï¼‰' >> /app/dev-start.sh && \
    echo '[ -f "infra/impl/document/parser/builtin/parse_pdf.py" ] && cp infra/impl/document/parser/builtin/parse_pdf.py /app/' >> /app/dev-start.sh && \
    echo '[ -f "infra/impl/document/parser/builtin/parse_docx.py" ] && cp infra/impl/document/parser/builtin/parse_docx.py /app/' >> /app/dev-start.sh && \
    echo '[ -f "infra/impl/coderunner/script/sandbox.py" ] && cp infra/impl/coderunner/script/sandbox.py /app/' >> /app/dev-start.sh && \
    echo '' >> /app/dev-start.sh && \
    echo '# ç¡®ä¿Pythonè„šæœ¬å¯æ‰§è¡Œ' >> /app/dev-start.sh && \
    echo 'chmod +x /app/*.py 2>/dev/null || true' >> /app/dev-start.sh && \
    echo '' >> /app/dev-start.sh && \
    echo '# å¯åŠ¨åº”ç”¨' >> /app/dev-start.sh && \
    echo 'echo "ğŸš€ å¯åŠ¨Cozeåç«¯æœåŠ¡..."' >> /app/dev-start.sh && \
    echo 'echo "ğŸ“¡ æœåŠ¡åœ°å€: http://localhost:8888"' >> /app/dev-start.sh && \
    echo 'echo "ğŸ”„ å¼€å‘æ¨¡å¼å·²å¯ç”¨ - ä¿®æ”¹ä»£ç åé‡å¯å®¹å™¨å³å¯"' >> /app/dev-start.sh && \
    echo 'exec /app/opencoze' >> /app/dev-start.sh && \
    chmod +x /app/dev-start.sh

# æš´éœ²ç«¯å£
EXPOSE 8888 8889

# ä½¿ç”¨å¼€å‘å¯åŠ¨è„šæœ¬
CMD ["/app/dev-start.sh"]
